<?php
session_start();
include '../koneksi/koneksi.php';
include '../inc/functions.php';
check_login('siswa');
include '../inc/datasiswa.php';

$kode_soal = $_POST['kode_soal'] ?? $_GET['kode_soal'] ?? '';
$id_siswa = $_SESSION['id_siswa'] ?? '';

if (empty($kode_soal) || empty($id_siswa)) {
    $_SESSION['alert'] = true;
    $_SESSION['warning_message'] = 'Kode soal atau ID siswa tidak tersedia.';
    header('Location: ujian.php');
    exit;
}

// Ambil sisa waktu dari jawaban_siswa
$waktu_sisa = 0;
$get_waktu = mysqli_query($koneksi, "SELECT waktu_sisa, jawaban_siswa FROM jawaban_siswa WHERE kode_soal='$kode_soal' AND id_siswa='$id_siswa'");
$jawaban_tersimpan = [];
if ($w = mysqli_fetch_assoc($get_waktu)) {
    $waktu_sisa = (int)$w['waktu_sisa'];
    $string_jawaban = $w['jawaban_siswa'];
    preg_match_all('/\[(\d+):(.*?)\]/', $string_jawaban, $matches, PREG_SET_ORDER);
    foreach ($matches as $match) {
        $nomor = (int)$match[1];
        $jawab = $match[2];
        if (str_contains($jawab, '|') && str_contains($jawab, ':')) {
            $jawaban_tersimpan[$nomor] = explode('|', $jawab);
        } elseif (str_contains($jawab, '|')) {
            $jawaban_tersimpan[$nomor] = explode('|', $jawab);
        } elseif (str_contains($jawab, ',')) {
            $jawaban_tersimpan[$nomor] = explode(',', $jawab);
        } else {
            $jawaban_tersimpan[$nomor] = $jawab;
        }
    }
}

// Ambil semua soal
$q = mysqli_query($koneksi, "SELECT * FROM butir_soal WHERE kode_soal='$kode_soal' ORDER BY nomer_soal ASC");
$soal = [];
while ($s = mysqli_fetch_assoc($q)) {
    $soal[] = $s;
}

$q_tema = mysqli_query($koneksi, "SELECT warna_tema FROM pengaturan WHERE id = 1 LIMIT 1");
$data_tema = mysqli_fetch_assoc($q_tema);
$warna_tema = $data_tema['warna_tema'] ?? '#0d6efd';
?>

<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ujian Siswa</title>
    <?php include '../inc/css.php'; ?>
    <?php include '../inc/cssujian.php'; ?>
    <style>
        .question-container {
            display: none;
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .question-container.active {
            display: block;
        }
        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        .question-nav {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 15px;
        }
        .question-nav button {
            min-width: 40px;
        }
        #loadingOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            color: white;
        }
        #autoSaveStatus {
            display: none;
            background-color: #28a745;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            margin-bottom: 10px;
            text-align: center;
        }
        .timer {
            font-weight: bold;
            font-size: 1.2rem;
            color: #dc3545;
            background-color: rgba(255,255,255,0.2);
            padding: 5px 10px;
            border-radius: 4px;
        }
        .question-text {
            font-weight: bold;
            margin-bottom: 15px;
        }
        .answer-option {
            margin-bottom: 8px;
        }
        .matching-table {
            width: 100%;
            margin-bottom: 15px;
        }
        .matching-table td {
            padding: 8px;
            vertical-align: middle;
        }
        .essay-textarea {
            width: 100%;
            min-height: 150px;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ced4da;
        }
        .submit-btn {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <!-- Loading Spinner Overlay -->
    <div id="loadingOverlay">
        <div class="spinner-container">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Memuat soal...</p>
        </div>
    </div>
    <div style="height: 75px;"></div>
    <div class="wrapper">
        <div class="main">
            <nav class="navbar navbar-expand navbar-light navbar-bg fixed-top" style="border-bottom:5px solid <?php echo htmlspecialchars($warna_tema); ?> !important;">
                <a class="navbar-brand ms-3" href="#">
                    <img src="../assets/images/cbticon.png" alt="Logo" style="height: 36px;">
                </a>
                <div class="navbar-collapse collapse">
                    <ul class="navbar-nav navbar-align ms-auto">
                        <!-- Timer Display -->
                        <li class="nav-item me-3">
                            <div class="timer">
                                <i class="fas fa-clock me-1"></i>
                                <span id="timer">00:00</span>
                            </div>
                        </li>
                        <li class="nav-item me-3">
                            <div class="dropdown-toggle" href="#" style="font-weight: bold; font-size: 1.2rem;" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-user-circle me-1"></i>
                            </div>
                            <ul class="dropdown-menu dropdown-menu-end dropdown-wide">
                                <li><span class="dropdown-item-text"><strong><?php echo $nama_siswa; ?></strong></span></li>
                                <li><span class="dropdown-item-text"><?php echo $kelas_siswa . $rombel_siswa; ?></span></li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </nav>
            <main class="content">
                <div class="container-fluid p-0">
                    <div class="row">
                        <div class="col-12">
                            <div class="card shadow">
                                <div class="card-header text-white" style="background-color:<?= htmlspecialchars($warna_tema) ?>">
                                    <h4 class="mb-0 text-white">
                                        <b style="background-color:#1c1c1c;padding:5px;border-radius:10px 0 0 10px;">No.</b>
                                        <b style="background-color:#ffffff;padding:5px;border-radius:0 10px 10px 0;color:black;" id="currentQuestionNumber">1</b>
                                    </h4>
                                </div>
                                <div class="card-body">
                                    <div id="autoSaveStatus"></div>
                                    <form id="formUjian" method="post" action="simpan_jawaban.php">
                                        <input type="hidden" name="kode_soal" value="<?= htmlspecialchars($kode_soal) ?>">
                                        
                                        <?php foreach ($soal as $index => $s): 
                                            $no = $s['nomer_soal'];
                                            $tipe = $s['tipe_soal'];
                                            $pertanyaan = $s['pertanyaan'];
                                            $jawaban = $jawaban_tersimpan[$no] ?? '';
                                        ?>
                                        <div class="question-container" id="soal-<?= $index ?>">
                                            <div class="question-text">Soal <?= $no ?>: <?= $pertanyaan ?></div>
                                            
                                            <?php if ($tipe == 'Pilihan Ganda'): ?>
                                                <?php for ($i = 1; $i <= 4; $i++): ?>
                                                    <div class="answer-option">
                                                        <label class="form-check-label">
                                                            <input type="radio" class="form-check-input" name="jawaban[<?= $no ?>]" value="pilihan_<?= $i ?>" <?= $jawaban == 'pilihan_'.$i ? 'checked' : '' ?>> 
                                                            <?= $s['pilihan_'.$i] ?>
                                                        </label>
                                                    </div>
                                                <?php endfor; ?>
                                            
                                            <?php elseif ($tipe == 'Pilihan Ganda Kompleks'): 
                                                $jawaban = is_array($jawaban) ? $jawaban : [];
                                            ?>
                                                <?php for ($i = 1; $i <= 4; $i++): ?>
                                                    <div class="answer-option">
                                                        <label class="form-check-label">
                                                            <input type="checkbox" class="form-check-input" name="jawaban[<?= $no ?>][]" value="pilihan_<?= $i ?>" <?= in_array('pilihan_'.$i, $jawaban) ? 'checked' : '' ?>> 
                                                            <?= $s['pilihan_'.$i] ?>
                                                        </label>
                                                    </div>
                                                <?php endfor; ?>
                                            
                                            <?php elseif ($tipe == 'Benar/Salah'): ?>
                                                <table class="matching-table">
                                                    <?php for ($i = 1; $i <= 4; $i++): 
                                                        $pernyataan = $s['pilihan_'.$i];
                                                        if (trim($pernyataan) == '') continue;
                                                        $jawab = $jawaban[$i - 1] ?? '';
                                                    ?>
                                                    <tr>
                                                        <td><?= $pernyataan ?></td>
                                                        <td>
                                                            <div class="form-check form-check-inline">
                                                                <input class="form-check-input" type="radio" name="jawaban[<?= $no ?>][<?= $i ?>]" value="Benar" <?= $jawab == 'Benar' ? 'checked' : '' ?>>
                                                                <label class="form-check-label">Benar</label>
                                                            </div>
                                                            <div class="form-check form-check-inline">
                                                                <input class="form-check-input" type="radio" name="jawaban[<?= $no ?>][<?= $i ?>]" value="Salah" <?= $jawab == 'Salah' ? 'checked' : '' ?>>
                                                                <label class="form-check-label">Salah</label>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                    <?php endfor; ?>
                                                </table>
                                            
                                            <?php elseif ($tipe == 'Menjodohkan'): ?>
                                                <?php 
                                                    $pasangan = explode('|', $s['jawaban_benar']);
                                                    $opsi = [];
                                                    foreach ($pasangan as $pair) {
                                                        $pecah = explode(':', $pair, 2);
                                                        if (count($pecah) == 2) {
                                                            $opsi[] = ['kiri' => trim($pecah[0]), 'kanan' => trim($pecah[1])];
                                                        }
                                                    }
                                                    $daftar_kanan = array_unique(array_column($opsi, 'kanan'));
                                                    shuffle($daftar_kanan);
                                                ?>
                                                <table class="matching-table">
                                                    <?php foreach ($opsi as $idx => $p): 
                                                        $selected = $jawaban[$idx] ?? '';
                                                    ?>
                                                    <tr>
                                                        <td><?= htmlspecialchars($p['kiri']) ?></td>
                                                        <td>
                                                            <input type="hidden" name="soal_kiri[<?= $no ?>][<?= $idx ?>]" value="<?= htmlspecialchars($p['kiri']) ?>">
                                                            <select name="jawaban[<?= $no ?>][]" class="form-select">
                                                                <option value="X">-- Pilih Pasangan --</option>
                                                                <?php foreach ($daftar_kanan as $dk): ?>
                                                                    <option value="<?= htmlspecialchars($dk) ?>" <?= $selected == $dk ? 'selected' : '' ?>><?= htmlspecialchars($dk) ?></option>
                                                                <?php endforeach; ?>
                                                            </select>
                                                        </td>
                                                    </tr>
                                                    <?php endforeach; ?>
                                                </table>
                                            
                                            <?php elseif ($tipe == 'Uraian'): ?>
                                                <textarea name="jawaban[<?= $no ?>]" class="essay-textarea"><?= htmlspecialchars($jawaban) ?></textarea>
                                            <?php endif; ?>
                                        </div>
                                        <?php endforeach; ?>
                                        
                                        <!-- Di bagian HTML (ganti bagian navigation-buttons) -->
                                            <div class="navigation-buttons">
                                                <div style="flex: 1;">
                                                    <!-- Tombol Sebelumnya (kiri) -->
                                                    <button type="button" class="btn btn-primary" id="prevBtn" onclick="prevSoal()" style="display: none; float: left;">
                                                        <i class="fas fa-arrow-left me-1"></i> Sebelumnya
                                                    </button>
                                                </div>
                                                <div style="flex: 1; text-align: right;">
                                                    <!-- Tombol Berikutnya/Selesai (kanan) -->
                                                    <button type="button" class="btn btn-primary" id="nextBtn" onclick="nextSoal()" style="float: right;">
                                                        Berikutnya <i class="fas fa-arrow-right ms-1"></i>
                                                    </button>
                                                    <button type="submit" class="btn btn-success" id="submitBtn" style="display: none; float: right;">
                                                        <i class="fas fa-check-circle me-1"></i> Selesai
                                                    </button>
                                                </div>
                                            </div>
                                        
                                        <div class="question-nav">
                                            <?php foreach ($soal as $index => $s): ?>
                                                <button type="button" class="btn btn-outline-primary" onclick="tampilSoal(<?= $index ?>)">
                                                    <?= $s['nomer_soal'] ?>
                                                </button>
                                            <?php endforeach; ?>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    <footer class="footer mt-auto py-3 bg-dark sticky-bottom">
        <div class="container-fluid">
            <div class="row text-grey">
                <div class="col-6 text-start">
                    <p class="mb-0">
                        <a href="#" id="enc" style="color:grey;"></a>
                    </p>
                </div>
            </div>
        </div>
    </footer>
    
    <script src="../assets/adminkit/static/js/app.js"></script>
    <script src="../assets/js/jquery-3.6.0.min.js"></script>
    <script src="../assets/js/sweetalert.js"></script>
    <script src="../assets/datatables/datatables.js"></script>
    
    <script>
        // Timer Logic
        let waktu = <?= $waktu_sisa > 0 ? ($waktu_sisa * 60) : 3600 ?>;
        let soalAktif = 0;
        const totalSoal = <?= count($soal) ?>;
        
        // Tampilkan loading overlay saat pertama kali load
        document.getElementById('loadingOverlay').style.display = 'flex';
        setTimeout(() => {
            document.getElementById('loadingOverlay').style.display = 'none';
        }, 500);

        function updateTimer() {
            let menit = Math.floor(waktu / 60);
            let detik = waktu % 60;
            document.getElementById('timer').innerText = `${menit.toString().padStart(2, '0')}:${detik.toString().padStart(2, '0')}`;
            waktu--;
            
            if (waktu < 0) {
                // Waktu habis, submit form
                document.getElementById('formUjian').submit();
            }
        }

        function updateNavigationButtons() {
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const submitBtn = document.getElementById('submitBtn');

        // Atur tombol Sebelumnya
        prevBtn.style.display = soalAktif > 0 ? 'block' : 'none';

        // Atur tombol Berikutnya/Selesai
        if (soalAktif < totalSoal - 1) {
            nextBtn.style.display = 'block';
            submitBtn.style.display = 'none';
        } else {
            nextBtn.style.display = 'none';
            submitBtn.style.display = 'block';
        }
    }

    function tampilSoal(index) {
        document.querySelectorAll('.question-container').forEach(s => s.classList.remove('active'));
        const soal = document.getElementById('soal-' + index);
        if (soal) {
            soal.classList.add('active');
            soalAktif = index;
            document.getElementById('currentQuestionNumber').textContent = <?= $soal[0]['nomer_soal'] ?> + index;
            updateNavigationButtons();
            
            // Scroll ke atas soal
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }
    }

    function nextSoal() {
        if (soalAktif < totalSoal - 1) {
            tampilSoal(soalAktif + 1);
        }
    }

    function prevSoal() {
        if (soalAktif > 0) {
            tampilSoal(soalAktif - 1);
        }
    }

    // Panggil pertama kali untuk inisialisasi
    updateNavigationButtons();
        // Tampilkan soal pertama saat halaman dimuat
        window.onload = function() {
            tampilSoal(0);
            setInterval(updateTimer, 1000);
            updateTimer(); // Panggil sekali untuk inisialisasi
        };

        /// Auto save setiap 30 detik
setInterval(() => {
    const form = document.getElementById('formUjian');
    const data = new FormData(form);
    data.append('waktu_sisa', Math.ceil(waktu / 60));

    fetch('autosave_jawaban.php', {
        method: 'POST',
        body: data
    })
    .then(res => res.text())
    .then(txt => console.log('Auto-saved:', txt));
}, 30000);
    </script>
</body>
</html>